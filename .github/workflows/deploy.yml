name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

jobs:
  # Run tests before deploying
  test:
    name: Pre-deploy Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: pbs/go.sum

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Run Go tests
        working-directory: ./pbs
        run: |
          go mod download
          go test -v ./...

      - name: Run Python tests
        run: |
          pip install -e ".[dev]"
          pytest tests/ -v

  # Deploy to Fly.io
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        id: deploy
        run: |
          flyctl deploy --remote-only
          echo "url=https://$(flyctl info --json | jq -r '.Hostname')" >> $GITHUB_OUTPUT

      - name: Verify deployment health
        run: |
          sleep 10
          curl -f https://$(flyctl info --json | jq -r '.Hostname')/health || exit 1

      - name: Post deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  # Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, deploy]
    if: failure()

    steps:
      - name: Send failure notification
        run: |
          echo "Deployment failed for commit ${{ github.sha }}"
          # Add Slack/Discord/Email notification here
          # Example: curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"Deployment failed!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}
